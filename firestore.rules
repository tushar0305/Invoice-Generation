/**
 * @fileoverview Firestore Security Rules for Saambh Jewellers Invoice App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only manage
 * their own data.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores customer profiles. (Not currently used, but rules are in place).
 * - /invoices/{invoiceId}: Stores invoice data. Only the user associated with the invoice (via userId) can read/write it.
 * - /invoices/{invoiceId}/invoiceItems/{invoiceItemId}: Stores invoice items. Access is inherited from the parent invoice.
 * - /userSettings/{userId}: Stores user settings. Only the authenticated user can read/write their own settings.
 *
 * Key Security Decisions:
 * - Users can ONLY manage their own invoices and associated data.
 * - Users can ONLY manage their own settings.
 * - Listing invoices is ONLY allowed when querying for one's own invoices.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: signed-in check
    function isSignedIn() {
      return request.auth != null;
    }

    // Invoices: per-document rules. Firestore evaluates 'read' (get + list) per document.
    // Simpler and more robust than attempting to introspect request.query.
    match /invoices/{invoiceId} {
      // Allow creation only if the new document's userId matches auth uid.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Allow reads (get & list), updates, deletes only if the existing document belongs to the user.
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Invoice items: must belong to an invoice the user owns.
      match /invoiceItems/{itemId} {
        allow read, write: if isSignedIn() &&
          get(/databases/$(database)/documents/invoices/$(invoiceId)).data.userId == request.auth.uid;
      }
    }

    // User settings: users can only read/write their own settings.
    match /userSettings/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Customers (optional): users can only read/write their own customer data.
    match /customers/{customerId} {
      allow read, write: if isSignedIn() && request.auth.uid == customerId;
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
