/**
 * @fileoverview Firestore Security Rules for Saambh Jewellers Invoice App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only manage
 * their own data.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores customer profiles. (Not currently used, but rules are in place).
 * - /invoices/{invoiceId}: Stores invoice data. Only the user associated with the invoice (via userId) can read/write it.
 * - /invoices/{invoiceId}/invoiceItems/{invoiceItemId}: Stores invoice items. Access is inherited from the parent invoice.
 *
 * Key Security Decisions:
 * - Users can ONLY manage their own invoices and associated data.
 * - Listing invoices is ONLY allowed when querying for one's own invoices.
 * - Data shape validation is omitted in this prototype for rapid iteration.
 *
 * Denormalization for Authorization:
 * - The `Invoice` entity includes a `userId` field. This is intentionally denormalized to avoid needing a `get()` operation to another collection to validate ownership when accessing invoices, which is more performant and a best practice for security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    match /customers/{customerId} {
      function isOwner() {
        return isSignedIn() && request.auth.uid == customerId;
      }

      allow read, write: if isOwner();
    }

    match /invoices/{invoiceId} {
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Allow reading a single document if the user is the owner.
      allow get: if isOwner(get(/databases/$(database)/documents/invoices/$(invoiceId)).data.userId);

      // Allow listing/querying documents only if the query is filtering by the user's own userId.
      // This is the key rule to allow `useCollection` with a `where('userId', '==', user.uid)` query.
      allow list: if isSignedIn() && request.query.where.size() == 1 && request.query.where[0].field == 'userId' && request.query.where[0].op == '==' && request.query.where[0].value == request.auth.uid;

      // Allow creating a document if the new document's userId matches the user's uid.
      allow create: if isOwner(request.resource.data.userId);

      // Allow updating a document if the user owns the existing document.
      allow update: if isOwner(get(/databases/$(database)/documents/invoices/$(invoiceId)).data.userId);
      
      // Allow deleting a document if the user owns it.
      allow delete: if isOwner(get(/databases/$(database)/documents/invoices/$(invoiceId)).data.userId);

      // Invoice items can be managed by the owner of the parent invoice.
      match /invoiceItems/{invoiceItemId} {
        function isInvoiceOwner() {
          return isSignedIn() && get(/databases/$(database)/documents/invoices/$(invoiceId)).data.userId == request.auth.uid;
        }
        allow read, write: if isInvoiceOwner();
      }
    }
  }
}
